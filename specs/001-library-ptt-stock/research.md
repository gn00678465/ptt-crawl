# 技術研究與決策

## 套件管理與環境設定

### 決策: 使用 uv 作為套件管理工具
**理由**: 
- 符合憲法要求，必須使用 uv 進行套件管理
- uv 提供更快的依賴解析和安裝速度
- 整合虛擬環境管理，簡化開發流程
- 支援現代 Python 專案結構（pyproject.toml）

**替代方案考量**:
- pip + virtualenv: 傳統方案但效能較差
- poetry: 功能完善但不符合憲法要求
- pipenv: 已過時且效能問題

### 決策: 核心依賴套件選擇

#### CLI 工具 - typer
**理由**:
- 基於 type hints 的現代 CLI 框架
- 自動生成說明文件和驗證
- 支援複雜的命令結構和子命令
- 良好的錯誤處理和使用者體驗

#### 網頁爬取 - firecrawl-py
**理由**:
- 專案需求明確指定使用 Firecrawl API
- 提供 Markdown 格式輸出，符合專案需求
- 支援 JavaScript 渲染，適合現代網頁
- 具備反爬蟲機制處理能力

#### 資料庫連接 - psycopg2-binary
**理由**:
- PostgreSQL 的標準 Python 驅動程式
- binary 版本無需編譯，部署便利
- 效能優異，支援連接池
- 廣泛使用且文件完整

#### 狀態管理 - redis-py
**理由**:
- 高效能的記憶體數據庫
- 支援 AOF/RDB 持久化
- 適合快速狀態查詢和更新
- 與 JSON 檔案備份形成雙層架構

## 爬取策略與實作模式

### 決策: 兩階段爬取流程
**理由**:
- **第一階段**: 爬取文章列表頁面，提取標題和連結
- **第二階段**: 根據篩選條件爬取完整文章內容
- 提供更好的效能和資源控制
- 支援更精確的分類篩選

**替代方案考量**:
- 單階段爬取: 效能差，資源浪費
- 即時爬取: 無法進行有效篩選

### 決策: 增量爬取與狀態管理
**理由**:
- 避免重複爬取相同內容，節省資源
- 支援中斷後繼續爬取
- 實現可靠的進度追蹤
- 符合憲法的狀態持久化要求

**狀態儲存策略**:
- **Redis**: 即時狀態更新和快速查詢
- **JSON 檔案**: 持久化備份，故障恢復
- **原子性操作**: 確保兩層狀態同步

## 資料模型設計

### 決策: 結構化資料模型
**核心實體**:
1. **Article** - 文章主體
   - title: 文章標題
   - author: 作者
   - board: 看板名稱  
   - url: 文章連結
   - content: Markdown 格式內容
   - publish_date: 發表時間
   - crawl_date: 爬取時間
   - category: 文章分類/標籤

2. **CrawlState** - 爬取狀態
   - board: 看板名稱
   - last_crawl_time: 最後爬取時間
   - processed_urls: 已處理URL列表
   - retry_count: 重試次數
   - status: 爬取狀態

**理由**:
- 符合 PostgreSQL 關聯式資料庫結構
- 支援高效查詢和索引
- 便於後續分析和擴展

## 錯誤處理與可靠性

### 決策: 多層錯誤處理機制
**網路錯誤**:
- 指數退避重試機制
- 斷路器模式防止級聯故障  
- 請求超時設定

**資料錯誤**:
- 內容驗證和清理
- 編碼錯誤處理
- 格式異常恢復

**狀態錯誤**:
- Redis 連接失敗自動切換至 JSON
- JSON 檔案損壞檢測和修復
- 狀態不一致自動同步

## 效能與限制

### 決策: 爬取頻率控制
**限制參數**:
- 每分鐘最多 60 個頁面
- 請求間隔 1-2 秒隨機變化
- 並發限制 3 個執行緒

**理由**:
- 遵守網站爬取禮儀
- 避免 IP 封鎖風險
- 確保服務穩定性

## 測試策略

### 決策: 分層測試架構
**單元測試**:
- 爬取邏輯測試
- 資料解析驗證  
- 狀態管理測試

**整合測試**:
- Firecrawl API 互動測試
- 資料庫操作測試
- 端到端流程驗證

**模擬測試**:
- 使用 mock 避免實際爬取
- 錯誤情境模擬
- 效能壓力測試

**測試工具**: pytest + pytest-mock + pytest-asyncio